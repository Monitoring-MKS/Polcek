<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLCEK MASTER - WH MAKASSAR</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --green: #70ad47; --bg-grey: #b0b0b0; --red: #ff0000; }
        * { box-sizing: border-box; font-family: 'Arial Black', sans-serif; }
        body, html { margin: 0; padding: 0; background: #2c3e50; height: 100vh; overflow: hidden; }
        .container { width: 100vw; height: 100vh; background: var(--bg-grey); display: flex; flex-direction: column; padding: 15px; position: relative; }
        .header { background: black; color: white; text-align: center; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        .input-row { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
        .label-tag { width: 130px; padding: 10px; font-size: 10px; color: white; border-radius: 5px; font-weight: bold; background: var(--green); }
        input { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #777; font-size: 14px; font-weight: bold; }
        input[readonly] { background: #dcdcdc; }
        .footer-btns { display: flex; gap: 8px; margin-top: 15px; }
        .btn { flex: 1; padding: 15px; border-radius: 5px; border: 1px solid white; color: white; cursor: pointer; font-weight: bold; font-size: 11px; background: black; }
        .btn-scan { background: #444; border: none; padding: 8px 12px; color: white; border-radius: 5px; }
        #loader { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; color: white; }
        #reader-container { display: none; position: fixed; inset: 0; background: black; z-index: 2000; flex-direction: column; }
    </style>
</head>
<body onload="initApp()">

<div class="container">
    <div id="loader"><p id="loader-text">Loading Data...</p></div>
    <div id="reader-container"><div id="reader" style="flex:1"></div><button class="btn" onclick="stopScanner()" style="background:red">BATAL SCAN</button></div>

    <div class="header">MASTER BARCODE</div>

    <div class="input-row">
        <div class="label-tag">BARCODE DOS</div>
        <input type="text" id="m_dos" placeholder="Scan Barcode DOS">
        <button class="btn-scan" onclick="startScanner('m_dos')">ðŸ“·</button>
    </div>
    <div class="input-row">
        <div class="label-tag" style="background: #2980b9;">BARCODE ITEM</div>
        <input type="text" id="m_item" placeholder="Scan Barcode Item">
        <button class="btn-scan" onclick="startScanner('m_item')">ðŸ“·</button>
    </div>
    <div class="input-row"><div class="label-tag">PLU</div><input type="text" id="m_plu" readonly></div>
    <div class="input-row"><div class="label-tag">DESCP</div><input type="text" id="m_descp" readonly></div>
    <div class="input-row"><div class="label-tag">C2</div><input type="text" id="m_c2" readonly></div>
    <div class="input-row"><div class="label-tag">LOKASI</div><input type="text" id="m_lokasi" readonly></div>
    <div class="input-row"><div class="label-tag">TAG</div><input type="text" id="m_tag" readonly></div>

    <div class="footer-btns">
        <button class="btn" style="background:#2ecc71" onclick="queueMaster()">+SIMPAN DATA </button>
        <button class="btn" style="background:var(--red)" onclick="syncBatch()">ðŸš€ KIRIM (<span id="q_count">0</span>)</button>
        <button class="btn" onclick="resetMasterForm()">CLEAR</button>
    </div>
</div>

<script>
    const G_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyTwbTbJEtrSyJXq0ERZg6FCj92A3lqOUWColaPmV4Bf1CAIYmuxFG-BCsQuXyb5O8/exec";
    let cachedMasterData = [];
    let savedBarcodesFromServer = [];
    let html5QrCode;

    // --- AUDIO ---
    function playSound(type) {
        try {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const osc = context.createOscillator();
            const gain = context.createGain();
            osc.connect(gain); gain.connect(context.destination);
            if (type === 'success') {
                osc.frequency.setValueAtTime(880, context.currentTime);
                osc.start(); osc.stop(context.currentTime + 0.1);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, context.currentTime);
                osc.start(); osc.stop(context.currentTime + 0.4);
            }
        } catch(e) { console.log("Audio Error"); }
    }

    // --- INIT ---
    async function initApp() {
        showLoader("Sinkronisasi Database...");
        try {
            const res = await fetch(G_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getAllMaster" }) });
            const out = await res.json();
            if (out.status === "success") {
                cachedMasterData = out.data;
                savedBarcodesFromServer = out.savedList;
                console.log("Master Loaded:", cachedMasterData.length);
            }
        } catch (e) { alert("Error: Cek Koneksi / URL Script"); }
        hideLoader();
        updateBadge();
    }

// Fungsi ini dipicu otomatis setelah scan atau tekan Enter di Barcode DOS
function handleDosInput(val) {
    const barcode = val.trim();
    if (!barcode) return;

    // 1. CEK KE DATABASE SERVER (Data yang ditarik saat awal buka APK)
    const sudahAdaDiServer = savedBarcodesFromServer.includes(barcode);

    // 2. CEK KE ANTRIAN LOKAL (Data yang masih parkir di HP belum dikirim)
    const queue = JSON.parse(localStorage.getItem('q_master') || "[]");
    const sudahAdaDiAntrian = queue.some(item => item.barcodeDos === barcode);

    if (sudahAdaDiServer || sudahAdaDiAntrian) {
        playSound('error'); // Bunyi Buzzer Gagal
        
        let pesan = sudahAdaDiServer 
            ? "âš ï¸ DATA SUDAH ADA DI SHEET!\nBarcode " + barcode + " sudah pernah tersimpan di server."
            : "âš ï¸ DATA SUDAH ADA DI ANTRIAN!\nBarcode " + barcode + " sudah diinput tapi belum dikirim.";
            
        alert(pesan);
        
        // LANGSUNG BERSIHKAN FORM
        resetMasterForm(); 
    } else {
        // Jika aman, pindahkan fokus ke Barcode Item untuk langkah selanjutnya
        document.getElementById('m_item').focus();
    }
}

// Tambahkan Trigger 'Blur' agar saat petugas klik kolom lain, validasi tetap jalan
document.getElementById('m_dos').onblur = function() {
    handleDosInput(this.value);
};

    function findItemMaster(val) {
        const barcode = val.trim();
        if (!barcode) return;

        const found = cachedMasterData.find(i => i.barcode === barcode);
        if (found) {
            document.getElementById('m_plu').value = found.plu;
            document.getElementById('m_descp').value = found.descp;
            document.getElementById('m_c2').value = found.c2;
            document.getElementById('m_lokasi').value = found.lokasi;
            document.getElementById('m_tag').value = found.tag;
            playSound('success');
        } else {
            playSound('error');
            alert("Barcode Item tidak ditemukan di Master!");
            document.getElementById('m_item').value = "";
        }
    }

    // --- ANTRIAN ---
    function queueMaster() {
        const bDos = document.getElementById('m_dos').value.trim();
        const bItem = document.getElementById('m_item').value.trim();

        if (!bDos || !bItem) {
            playSound('error');
            return alert("Lengkapi Barcode DOS & ITEM!");
        }

        const data = {
            barcodeDos: bDos, barcodeItem: bItem,
            plu: document.getElementById('m_plu').value,
            descp: document.getElementById('m_descp').value,
            lokasi: document.getElementById('m_lokasi').value,
            c2: document.getElementById('m_c2').value,
            tag: document.getElementById('m_tag').value
        };

        let queue = JSON.parse(localStorage.getItem('q_master') || "[]");
        queue.push(data);
        localStorage.setItem('q_master', JSON.stringify(queue));

        playSound('success');
        resetMasterForm();
        updateBadge();
    }

    async function syncBatch() {
        const queue = JSON.parse(localStorage.getItem('q_master') || "[]");
        if (queue.length === 0) return alert("Tidak ada data dikirim.");

        showLoader("Mengirim...");
        try {
            const res = await fetch(G_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "syncBatch", data: queue }) });
            const out = await res.json();
            if (out.status === "success") {
                queue.forEach(i => savedBarcodesFromServer.push(i.barcodeDos));
                localStorage.setItem('q_master', "[]");
                updateBadge();
                alert("Berhasil Terkirim!");
            }
        } catch (e) { alert("Gagal Kirim!"); }
        hideLoader();
    }

    // --- UI HELPER ---
    function updateBadge() {
        const q = JSON.parse(localStorage.getItem('q_master') || "[]").length;
        document.getElementById('q_count').innerText = q;
    }

    function resetMasterForm() {
        const ids = ['m_dos','m_item','m_plu','m_descp','m_c2','m_lokasi','m_tag'];
        ids.forEach(id => document.getElementById(id).value = '');
        document.getElementById('m_dos').focus();
    }

    function showLoader(t) { document.getElementById('loader-text').innerText = t; document.getElementById('loader').style.display = 'flex'; }
    function hideLoader() { document.getElementById('loader').style.display = 'none'; }

    // Event Triggers
    document.getElementById('m_dos').onkeydown = (e) => { if(e.key === "Enter") handleDosInput(e.target.value); };
    document.getElementById('m_item').onkeydown = (e) => { if(e.key === "Enter") findItemMaster(e.target.value); };

    function startScanner(tid) {
        document.getElementById('reader-container').style.display = 'flex';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (txt) => {
            document.getElementById(tid).value = txt;
            if(tid === 'm_dos') handleDosInput(txt);
            if(tid === 'm_item') findItemMaster(txt);
            stopScanner();
        }).catch(() => stopScanner());
    }
    function stopScanner() { 
        if(html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById('reader-container').style.display='none';
                html5QrCode = null;
            });
        } else {
            document.getElementById('reader-container').style.display='none';
        }
    }
</script>
</body>
</html>
